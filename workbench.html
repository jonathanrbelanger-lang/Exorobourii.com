<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Project Janus | Mechanistic Workbench</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg-color: #050505;
      --panel-bg: #0f1115;
      --border-color: #2a2f3a;
      --text-main: #e2e8f0;
      --text-muted: #64748b;
      --accent-cyan: #38bdf8;
      --accent-red: #ef4444;
      --accent-green: #22c55e;
      --accent-purple: #c084fc;
      --font-mono: 'Fira Code', 'Courier New', monospace;
      --font-sans: system-ui, -apple-system, sans-serif;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background-color: var(--bg-color);
      color: var(--text-main);
      font-family: var(--font-sans);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* --- NAVIGATION --- */
    nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 2rem;
      height: 60px;
      background-color: var(--panel-bg);
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
    }

    .brand {
      font-family: var(--font-mono);
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--text-main);
      text-decoration: none;
      letter-spacing: -0.5px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand span { color: var(--accent-cyan); }

    .nav-links { display: flex; gap: 1.5rem; }

    .nav-links a {
      color: var(--text-muted);
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 500;
      transition: color 0.2s;
    }

    .nav-links a:hover, .nav-links a.active { color: var(--accent-cyan); }

    /* --- LAYOUT --- */
    .workbench-container {
      flex: 1;
      display: grid;
      grid-template-columns: 300px 1fr;
      grid-template-rows: 1fr 200px;
      overflow: hidden;
    }

    /* --- SIDEBAR (CONTROLS) --- */
    .sidebar {
      background-color: #0a0c10;
      border-right: 1px solid var(--border-color);
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 2rem;
      grid-row: 1 / -1;
      overflow-y: auto;
    }

    .control-group { display: flex; flex-direction: column; gap: 0.8rem; }
    
    .label {
      font-family: var(--font-mono);
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .stat-card {
      background: var(--panel-bg);
      border: 1px solid var(--border-color);
      padding: 1rem;
      border-radius: 4px;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-main);
      font-family: var(--font-mono);
    }

    .stat-label { font-size: 0.8rem; color: var(--text-muted); margin-top: 4px; }

    .toggle-wrapper {
      display: flex;
      background: var(--panel-bg);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 2px;
    }

    .toggle-btn {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text-muted);
      padding: 8px;
      cursor: pointer;
      font-family: var(--font-mono);
      font-size: 0.8rem;
      transition: all 0.2s;
    }

    .toggle-btn.active {
      background: var(--border-color);
      color: var(--text-main);
      font-weight: bold;
    }

    /* --- MAIN VISUALIZATION --- */
    .main-view {
      padding: 2rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 2rem;
      background: radial-gradient(circle at top right, #111827 0%, #050505 40%);
    }

    /* --- CHART CONTAINER FIX --- */
    .chart-container {
      background: var(--panel-bg);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 1.5rem;
      position: relative;
      /* FIX: Strict height + overflow hidden prevents infinite loop */
      height: 350px; 
      width: 100%;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .chart-wrapper {
      flex: 1;
      position: relative;
      min-height: 0; /* Crucial for flex child resizing */
      width: 100%;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      flex-shrink: 0; /* Header won't shrink */
    }

    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: var(--accent-green);
      box-shadow: 0 0 10px var(--accent-green);
    }

    /* --- BOTTOM CONSOLE --- */
    .console-drawer {
      grid-column: 2;
      background-color: #08090b;
      border-top: 1px solid var(--border-color);
      padding: 1rem;
      font-family: var(--font-mono);
      font-size: 0.85rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .console-line { margin-bottom: 4px; display: flex; gap: 10px; }
    .timestamp { color: var(--text-muted); }
    .log-msg { color: var(--text-main); }
    .log-info { color: var(--accent-cyan); }
    .log-warn { color: var(--accent-red); }
    .log-success { color: var(--accent-green); }

    /* --- ABLATION GRID --- */
    .ablation-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 4px;
      margin-top: 10px;
      flex: 1; /* Fill remaining space in container */
    }

    .head-cell {
      background: var(--border-color);
      border-radius: 2px;
      cursor: pointer;
      transition: transform 0.1s;
      position: relative;
      height: 100%; /* Fill grid cell */
    }

    .head-cell:hover { transform: scale(1.1); z-index: 10; border: 1px solid white; }
    
    .tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #000;
      border: 1px solid var(--border-color);
      padding: 5px 10px;
      font-size: 0.75rem;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 20;
    }
    .head-cell:hover .tooltip { opacity: 1; }

    /* --- RESPONSIVE --- */
    @media (max-width: 1024px) {
      .workbench-container { grid-template-columns: 1fr; grid-template-rows: auto 1fr 150px; }
      .sidebar { flex-direction: row; flex-wrap: wrap; padding: 1rem; border-right: none; border-bottom: 1px solid var(--border-color); }
      .control-group { min-width: 200px; }
    }
    
    @media (max-width: 768px) {
      nav { flex-direction: column; height: auto; padding: 1rem; }
      .nav-links { flex-wrap: wrap; justify-content: center; gap: 1rem; }
    }
  </style>
</head>
<body>

  <nav>
    <a href="index.html" class="brand">
      <span>EXO</span>ROBOURII // JANUS WORKBENCH
    </a>
    <div class="nav-links">
      <a href="index.html">Home</a>
      <a href="helpdesk.html">Terminal</a>
      <a href="projects.html">Projects</a>
      <a href="workbench.html" class="active">Workbench</a>
      <a href="staff.html">Staff</a>
      <a href="about.html">About</a>
    </div>
  </nav>

  <div class="workbench-container">
    
    <!-- SIDEBAR CONTROLS -->
    <aside class="sidebar">
      <div class="control-group">
        <div class="label">Model Configuration</div>
        <div class="toggle-wrapper">
          <button class="toggle-btn" onclick="setMode('control')" id="btn-control">Control (Baseline)</button>
          <button class="toggle-btn active" onclick="setMode('adaptive')" id="btn-adaptive">Adaptive (VSM)</button>
        </div>
      </div>

      <div class="control-group">
        <div class="label">Live Telemetry</div>
        <div class="stat-card">
          <div class="stat-value" id="stat-rank">307.5</div>
          <div class="stat-label">Effective Rank (Layer 6)</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-sparsity" style="color: var(--accent-green)">73.9</div>
          <div class="stat-label">Feature Density (L0)</div>
        </div>
      </div>

      <div class="control-group">
        <div class="label">P-Controller State</div>
        <div style="font-family: var(--font-mono); font-size: 0.8rem; color: var(--text-muted);">
          Target σ: <span style="color: var(--accent-cyan)">0.0035</span><br>
          Current λ: <span style="color: var(--accent-cyan)" id="lambda-val">0.124</span><br>
          Status: <span style="color: var(--accent-green)">HOMEOSTASIS</span>
        </div>
      </div>
    </aside>

    <!-- MAIN VISUALIZATION -->
    <main class="main-view">
      
      <!-- ROW 1: SPARSITY & TOPOLOGY -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
        
        <!-- SPARSITY CHART -->
        <div class="chart-container">
          <div class="section-header">
            <div class="section-title">
              <div class="status-dot"></div>
              Feature Density (Sparsity Crossover)
            </div>
          </div>
          <div class="chart-wrapper">
            <canvas id="sparsityChart"></canvas>
          </div>
        </div>

        <!-- TOPOLOGY CHART -->
        <div class="chart-container">
          <div class="section-header">
            <div class="section-title">
              <div class="status-dot"></div>
              Subspace Geometry (Rank)
            </div>
          </div>
          <div class="chart-wrapper">
            <canvas id="topologyChart"></canvas>
          </div>
        </div>
      </div>

      <!-- ROW 2: ABLATION MAP -->
      <div class="chart-container">
        <div class="section-header">
          <div class="section-title">
            <div class="status-dot" style="background-color: var(--accent-red)"></div>
            Functional Ablation Map (Load-Bearing Heads)
          </div>
          <div class="label">Layer 9 Sensitivity</div>
        </div>
        <div class="ablation-grid" id="ablationGrid">
          <!-- Generated by JS -->
        </div>
        <div style="margin-top: 10px; font-size: 0.8rem; color: var(--text-muted); text-align: center;">
          Brighter Color = Higher Impact on Loss (Critical Component)
        </div>
      </div>

    </main>

    <!-- BOTTOM CONSOLE -->
    <footer class="console-drawer" id="console">
      <div class="console-line">
        <span class="timestamp">[09:00:01]</span>
        <span class="log-msg">Workbench initialized. Loaded artifacts: <span class="log-info">janus-v3-adaptive.pt</span></span>
      </div>
      <div class="console-line">
        <span class="timestamp">[09:00:02]</span>
        <span class="log-msg">Parsing telemetry data... <span class="log-success">OK</span></span>
      </div>
      <div class="console-line">
        <span class="timestamp">[09:00:02]</span>
        <span class="log-msg">Connecting to SAE interface... <span class="log-success">OK</span></span>
      </div>
    </footer>

  </div>

<script>
  // --- RAW DATA ---
  const DATA = {
    sparsity: [
      { layer: 3, control: 32.4, adaptive: 28.4 },
      { layer: 6, control: 39.7, adaptive: 45.5 },
      { layer: 9, control: 58.9, adaptive: 73.9 }
    ],
    topology: [
      { layer: 3, control: 280.4, adaptive: 289.5 },
      { layer: 6, control: 282.1, adaptive: 307.5 },
      { layer: 9, control: 286.9, adaptive: 290.4 }
    ],
    ablation: {
      control: [0.29, 0.19, 0.08, 0.07, 0.17, 0.15, 0.26, 0.36], 
      adaptive: [0.93, 0.14, 0.22, 0.43, 0.27, 0.35, 0.12, 0.33] 
    }
  };

  // --- STATE ---
  let currentMode = 'adaptive';
  let charts = {};

  // --- INITIALIZATION ---
  window.onload = function() {
    initCharts();
    renderAblationGrid();
    log("Ready. Displaying Layer 9 analysis.", "success");
  };

  // --- CHARTS ---
  function initCharts() {
    // 1. Sparsity Chart (Line)
    const ctxSparsity = document.getElementById('sparsityChart').getContext('2d');
    charts.sparsity = new Chart(ctxSparsity, {
      type: 'line',
      data: {
        labels: ['Layer 3', 'Layer 6', 'Layer 9'],
        datasets: [
          {
            label: 'Control (Baseline)',
            data: DATA.sparsity.map(d => d.control),
            borderColor: '#ef4444',
            backgroundColor: '#ef4444',
            borderDash: [5, 5],
            tension: 0.4
          },
          {
            label: 'Adaptive (VSM)',
            data: DATA.sparsity.map(d => d.adaptive),
            borderColor: '#38bdf8',
            backgroundColor: '#38bdf8',
            tension: 0.4
          }
        ]
      },
      options: getChartConfig('Feature Density (L0)')
    });

    // 2. Topology Chart (Bar)
    const ctxTopology = document.getElementById('topologyChart').getContext('2d');
    charts.topology = new Chart(ctxTopology, {
      type: 'bar',
      data: {
        labels: ['Layer 3', 'Layer 6', 'Layer 9'],
        datasets: [
          {
            label: 'Control',
            data: DATA.topology.map(d => d.control),
            backgroundColor: 'rgba(239, 68, 68, 0.5)',
            borderColor: '#ef4444',
            borderWidth: 1
          },
          {
            label: 'Adaptive',
            data: DATA.topology.map(d => d.adaptive),
            backgroundColor: 'rgba(56, 189, 248, 0.5)',
            borderColor: '#38bdf8',
            borderWidth: 1
          }
        ]
      },
      options: getChartConfig('Effective Rank')
    });
  }

  function getChartConfig(yLabel) {
    return {
      responsive: true,
      maintainAspectRatio: false, // Allows chart to fill container height
      plugins: {
        legend: { labels: { color: '#94a3b8', font: { family: 'Fira Code' } } }
      },
      scales: {
        y: {
          title: { display: true, text: yLabel, color: '#64748b' },
          grid: { color: '#1e293b' },
          ticks: { color: '#94a3b8', font: { family: 'Fira Code' } }
        },
        x: {
          grid: { color: '#1e293b' },
          ticks: { color: '#94a3b8', font: { family: 'Fira Code' } }
        }
      }
    };
  }

  // --- ABLATION GRID RENDERER ---
  function renderAblationGrid() {
    const grid = document.getElementById('ablationGrid');
    grid.innerHTML = '';
    
    const data = DATA.ablation[currentMode];
    const maxVal = Math.max(...DATA.ablation.adaptive); 

    data.forEach((val, index) => {
      const cell = document.createElement('div');
      cell.className = 'head-cell';
      
      const intensity = val / maxVal;
      const r = Math.floor(intensity * 255);
      const b = Math.floor((1 - intensity) * 100);
      
      cell.style.backgroundColor = `rgba(${r}, 50, ${b}, 0.6)`;
      cell.style.border = `1px solid rgba(${r}, 50, ${b}, 1)`;

      const tooltip = document.createElement('div');
      tooltip.className = 'tooltip';
      tooltip.innerHTML = `Head ${index}<br>Impact: ${val.toFixed(3)}%`;
      cell.appendChild(tooltip);

      cell.onclick = () => {
        log(`Analyzing Layer 9, Head ${index}...`, "info");
        if (currentMode === 'adaptive' && index === 0) {
          setTimeout(() => log(">> LOAD BEARING HEAD DETECTED. Semantic Binding: 'fox', 'lazy', 'brown'", "success"), 300);
        } else if (currentMode === 'control' && index === 7) {
          setTimeout(() => log(">> REDUNDANT HEAD. Syntactic Scaffolding: 'that', 'has', 'of'", "warn"), 300);
        }
      };

      grid.appendChild(cell);
    });
  }

  // --- INTERACTION ---
  function setMode(mode) {
    if (currentMode === mode) return;
    currentMode = mode;
    
    document.getElementById('btn-control').classList.toggle('active', mode === 'control');
    document.getElementById('btn-adaptive').classList.toggle('active', mode === 'adaptive');

    if (mode === 'adaptive') {
      document.getElementById('stat-rank').innerText = "307.5";
      document.getElementById('stat-sparsity').innerText = "73.9";
      document.getElementById('stat-sparsity').style.color = "var(--accent-green)";
      document.getElementById('lambda-val').innerText = "0.124";
      log("Switched to ADAPTIVE model context.", "info");
    } else {
      document.getElementById('stat-rank').innerText = "282.1";
      document.getElementById('stat-sparsity').innerText = "58.9";
      document.getElementById('stat-sparsity').style.color = "var(--accent-red)";
      document.getElementById('lambda-val').innerText = "0.000";
      log("Switched to CONTROL model context.", "warn");
    }

    renderAblationGrid();
  }

  function log(msg, type = "normal") {
    const consoleDiv = document.getElementById('console');
    const line = document.createElement('div');
    line.className = 'console-line';
    
    const time = new Date().toLocaleTimeString('en-US', { hour12: false });
    let colorClass = "log-msg";
    if (type === "info") colorClass = "log-info";
    if (type === "warn") colorClass = "log-warn";
    if (type === "success") colorClass = "log-success";

    line.innerHTML = `
      <span class="timestamp">[${time}]</span>
      <span class="${colorClass}">${msg}</span>
    `;
    
    consoleDiv.appendChild(line);
    consoleDiv.scrollTop = consoleDiv.scrollHeight;
  }

</script>
</body>
</html>